image: ubuntu:latest

variables:
  DOCKER_IMAGE: "frontend-image:latest"
  REGISTRY_URL: "docker.io"
  DOCKERHUB_REPO: "auttto/frontend"
  DOCKERHUB_USERNAME: "auttto"
  GITLAB_TOKEN: "$CI_JOB_TOKEN"  # GitLab CI ÌôòÍ≤Ω Î≥ÄÏàòÏóêÏÑú ÏûêÎèôÏúºÎ°ú Ï†úÍ≥µÎêòÎäî ÌÜ†ÌÅ∞
  GITLAB_USERNAME: root # push ÏûëÏóÖÏùÑ ÏàòÌñâÌï† GitLab Ïú†Ï†ÄÎ™Ö
  HARBOR_USERNAME: admin
  # GITLAB_URL  # GitLab Ï£ºÏÜå - secret variable Ïóê Ï†ïÏùò
  # DOCKERHUB_PASSWORD # DOCKERHUB ÎπÑÎ∞ÄÎ≤àÌò∏ - secret variable Ïóê Ï†ïÏùò
  # GITLAB_CHART_REPO  # Helm Ï∞®Ìä∏Ïùò GitLab Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ïù¥Î¶Ñ - secret variable Ïóê Ï†ïÏùò
  # GITLAB_EMAIL # push ÏûëÏóÖÏùÑ ÏàòÌñâÌï† GitLab Ïú†Ï†ÄÏùò Ïù¥Î©îÏùº - secret variable Ïóê Ï†ïÏùò
  # HARBOR_URL # ÌïòÎ≤Ñ Ïù¥ÎØ∏ÏßÄ Î†àÏßÄÏä§Ìä∏Î¶¨ Ï£ºÏÜå - sercret variable Ïóê Ï†ïÏùò
  # HARBOR_PASSWORD # ÌïòÎ≤Ñ Í≥ÑÏ†ï ÎπÑÎ∞ÄÎ≤àÌò∏ - sercret variable Ïóê Ï†ïÏùò

# main Î∏åÎûúÏπòÏóêÏÑúÎßå ÌååÏù¥ÌîÑÎùºÏù∏ Ïã§Ìñâ
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

stages:
  - organize # Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
  - build # Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  - push_dockerhub # Ïù¥ÎØ∏ÏßÄ ÎèÑÏª§ ÌóàÎ∏åÏóê Ìë∏Ïâ¨
  - push_harbor # Ïù¥ÎØ∏ÏßÄ ÌïòÎ≤ÑÏóê Ìë∏Ïãú
  - clone_helm # Ìó¨Î¶ÑÏ∞®Ìä∏ ÌÅ¥Î°†
  - update_helm # Ìó¨Î¶ÑÏ∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏

image_organize:
  stage: organize
  script:
    - docker image prune -a -f # ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
    - docker system prune -a -f # Ï†ÑÏ≤¥ Î∂àÌïÑÏöîÌïú Docker ÏûêÏõê Ï†ïÎ¶¨

image_build:
  stage: build
  script:
    - echo "Building Docker image..."
    - docker build -t $DOCKER_IMAGE .

image_push_dockerhub:
  stage: push_dockerhub
  script:
    # Í∞ÄÏû• ÏµúÍ∑º ÌÉúÍ∑∏Î•º Í∞ÄÏ†∏Ïò§Í∏∞
    - git fetch --tags --force
    - VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0") # ÌÉúÍ∑∏Í∞Ä ÏóÜÎã§Î©¥ Í∏∞Î≥∏ 0.0.0 ÌÉúÍ∑∏ Î∂ÄÏó¨

    # Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ Î∂ÄÏó¨
    - IMAGE_TAG=${VERSION_TAG}.${CI_PIPELINE_ID}
    - IMAGE=${DOCKERHUB_REPO}:${IMAGE_TAG}

    # Ïù¥ÎØ∏ÏßÄ Î≥ÄÏàòÎ•º Ï†ÑÏó≠ Î≤îÏúÑÎ°ú Ï†ÄÏû•
    - echo "IMAGE_TAG=${IMAGE_TAG}" >> build.env

    # Docker Î°úÍ∑∏Ïù∏
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    
    # ÌÉúÍπÖ Î∞è Ìë∏Ïãú
    - echo "üì§ Pushing $IMAGE image to DockerHub..."
    - docker tag $DOCKER_IMAGE $IMAGE
    - docker push $IMAGE

  artifacts:
    reports:
      dotenv: build.env

image_push_harbor:
  stage: push_harbor
  script:
    - echo "üì§ Pushing $IMAGE image to Harbor..."
    - docker login ${HARBOR_URL} -u ${HARBOR_USERNAME} -p ${HARBOR_PASSWORD}
    - docker tag $DOCKER_IMAGE ${HARBOR_URL}/${DOCKERHUB_REPO}:${IMAGE_TAG}
    - docker push ${HARBOR_URL}/${DOCKERHUB_REPO}:${IMAGE_TAG}