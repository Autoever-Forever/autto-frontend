image: ubuntu:latest

variables:
  DOCKER_IMAGE: "frontend-image:latest"
  REGISTRY_URL: "docker.io"
  DOCKERHUB_REPO: "auttto/frontend"
  DOCKERHUB_USERNAME: "auttto"
  GITLAB_TOKEN: "$CI_JOB_TOKEN"  # GitLab CI í™˜ê²½ ë³€ìˆ˜ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë˜ëŠ” í† í°
  GITLAB_USERNAME: root # push ì‘ì—…ì„ ìˆ˜í–‰í•  GitLab ìœ ì €ëª…
  # GITLAB_URL  # GitLab ì£¼ì†Œ - secret variable ì— ì •ì˜
  # DOCKERHUB_PASSWORD # DOCKERHUB ë¹„ë°€ë²ˆí˜¸ - secret variable ì— ì •ì˜
  # GITLAB_CHART_REPO  # Helm ì°¨íŠ¸ì˜ GitLab ë ˆí¬ì§€í† ë¦¬ ì´ë¦„ - secret variable ì— ì •ì˜
  # GITLAB_EMAIL # push ì‘ì—…ì„ ìˆ˜í–‰í•  GitLab ìœ ì €ì˜ ì´ë©”ì¼ - secret variable ì— ì •ì˜

# main ë¸Œëœì¹˜ì—ì„œë§Œ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

stages:
  - organize # ì´ë¯¸ì§€ ì •ë¦¬
  - build # ì´ë¯¸ì§€ ë¹Œë“œ
  - push_dockerhub # ì´ë¯¸ì§€ ë„ì»¤ í—ˆë¸Œì— í‘¸ì‰¬

image_organize:
  stage: organize
  script:
    - docker image prune -a -f # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
    - docker system prune -a -f # ì „ì²´ ë¶ˆí•„ìš”í•œ Docker ìì› ì •ë¦¬

image_build:
  stage: build
  script:
    - echo "Building Docker image..."
    - docker build -t $DOCKER_IMAGE .

image_push_dockerhub:
  stage: push_dockerhub
  script:
    # ê°€ì¥ ìµœê·¼ íƒœê·¸ë¥¼ ê°€ì ¸ì˜¤ê¸°
    - git fetch --tags --force
    - VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0") # íƒœê·¸ê°€ ì—†ë‹¤ë©´ ê¸°ë³¸ 0.0.0 íƒœê·¸ ë¶€ì—¬

    # ì´ë¯¸ì§€ íƒœê·¸ ë¶€ì—¬
    - IMAGE_TAG=${VERSION_TAG}.${CI_PIPELINE_ID}
    - IMAGE=${DOCKERHUB_REPO}:${IMAGE_TAG}

    # ì´ë¯¸ì§€ ë³€ìˆ˜ë¥¼ ì „ì—­ ë²”ìœ„ë¡œ ì €ì¥
    - echo "IMAGE_TAG=${IMAGE_TAG}" >> build.env

    # Docker ë¡œê·¸ì¸
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    
    # íƒœê¹… ë° í‘¸ì‹œ
    - echo "ğŸ“¤ Pushing $IMAGE image to DockerHub..."
    - docker tag $DOCKER_IMAGE $IMAGE
    - docker push $IMAGE

  artifacts:
    reports:
      dotenv: build.env
